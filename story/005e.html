<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Story</title>
  <style type="text/css">
    body {
    cursor:crosshair;
      padding:0;
      margin:0;
      background-color:#000000;
      font-family: 'Circular Std', sans-serif;
      letter-spacing: 1px;
      color:white;

      -webkit-font-smoothing: antialiased;
         -moz-font-smoothing: antialiased;
           -o-font-smoothing: antialiased;
              font-smoothing: antialiased;
    }
    text {
      font-size: 20px;
    }
    canvas { 
      width: 100%; 
      height: 100% 
    }

    a, a:link, a:visited {
      color: white;
      text-decoration: none;
      -webkit-transition: opacity 1s ease;
      -moz-transition: opacity 1s ease;
      -o-transition: opacity 1s ease;
      transition: opacity 1s ease;
    }

    a:hover, a:active {
      opacity: .5;
    }

    .back:before {
      content:"\2190 \2003";
      cursor:pointer;
    }

  </style>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>

<body>
  <div class="return-notification" id="return-notification" style="z-index: 999; position: fixed; width:100%; top:45%; text-align: center; margin:0 auto; font-family:'Circular Std', Helvetica, serif; font-size:36px; letter-spacing:0px; display:none; opacity:0;">
    <p id="return-notification-message" style="font-weight:800; margin: 0;">
      Returning to overview in 10 seconds
    </p>
    <p style="font-weight:100; margin: 0; font-size:20px">
      Move the cursor to stay on the page
    </p>
  </div>
  <div class="loading" id="loading" style="z-index: 999; position: fixed; width:100%; top:45%; text-align: center; margin:0 auto; font-family:'Circular Std', Helvetica, serif; font-size:36px; letter-spacing:0px;">
    <p style="font-weight:800; margin: 0">
      Loading data...
    </p>
  </div>
  <div class="info" id="info" style="z-index: 999; position: fixed; width:100%; bottom:0; text-align: center; margin:2em auto; font-family:'Circular Std', Helvetica, serif; font-size:16px; letter-spacing:0px;">
    <p style="font-weight:800; margin: 0;">
      The inner solar system, including the asteroid belt. 
    </p>
    <p style="font-weight:100; margin: 0;">
      Potentially hazardous asteroids, objects that could pose a threat to earth, are marked in red.
    </p>
    <p style="font-weight:100; margin: 0;">
      <br>
      <a class="back" href="javascript:void(0);" onclick="returnNow();">Return to overview</a>
    </p>
  </div>
  <div id="canvas-wrapper" style="z-index: -500">
  </div>

  <script type="text/javascript">

  var readySetGo = false;

  var w = window.innerWidth, h = window.innerHeight;
  var paddingW = w/10,
      paddingH = h/10;

  var number  = 1000;
  var n = 400;

  var day = 5902;

  function degree(x) {
    return x - Math.floor(x/360.0)*360.0;
  }

  var enlarge = 200;

  // COLORS    
  // var designerBlack = d3.rgb("#12141A"), // Define a nice black color for the background, store it as var
     var designerBlack = d3.rgb("#000000"),
      designerRed = d3.rgb("#c83c46"),
      designerWhite = d3.rgb("#ffe9d2");


  var hottestColor = d3.rgb("#9eb5ff"), // hottest color in the graph
      hotColor = d3.rgb("white"), // hot color in the graph
      midColor = d3.rgb("#ffe9d2")
      coldColor = d3.rgb("#ffd5a1"), // cold color in the graph
      coldestColor = d3.rgb("#ff5200"); // coldest color in the graph

      d3.select("body").style("background-color", designerBlack);


 // var svg = d3.select("body").append("svg")
 //                             .attr("id","svg")
 //                             .attr("class","svg")
 //                             .attr("width", w)
 //                             .attr("height", h);

  // Create the SVG Viewport
  var canvas = d3.select("#canvas-wrapper").append("canvas")
                             .attr("id","container")
                             .attr("class","container")
                             .attr("width", w)
                             .attr("height", h);

  var context = canvas.node().getContext('2d');

  var detachedContainer = document.createElement("custom");
  var dataContainer = d3.select(detachedContainer);

  context.fillStyle = "none";
  context.strokeStyle = designerWhite;



  // // Create defs in the svg
  // var defs = svg.append("defs");
  // var fxGroup = svg.append("g").attr("id", "fx-group");
  // var asteroidsGroup = svg.append("g").attr("id","asteroids-group");
  // var labelGroup = svg.append("g").attr("id", "label-group");
  // var sunGroup = svg.append("g").attr("id", "sun-group");


//   var zoom = d3.behavior.zoom()
//     .translate([0, 0])
//     .scale(1)
//     .scaleExtent([.5, 4])
//     .on("zoom", zoomed);

// svg.call(zoom);

// starsGroup.selectAll( "path" )
//   .data( stars_six_json.features )
//   .enter()
//   .append( "path" )
//   .attr("class", function(d) { return "star star-" + d.id})
//   .attr( "fill", "url(#radial-gradient)" )
//   .style("opacity", 1)
//   .attr( "d", path )
  // .transition().duration( function() { return Math.random() * (5000 - 2000) + 2000})
  // .style("opacity", 1);

  context.fillStyle = "yellow";
  context.strokeStyle = 'none';
  context.beginPath();
  context.arc(0, 0, 2, 0, 2 * Math.PI, true);
  context.fill();
  context.closePath();

d3.csv("data/results_asteroids_n_pha3.csv", function(error, rows) {
  if (error) throw error;

  // rows.forEach(function(d) {
  //   id: d.id;
  //   name: d.name;
  //   semimajor_axis: +d.a;
  //   eccentricity: +d.e;
  //   // magnitude: +d.mag;
  // });


  var dataBinding = dataContainer.selectAll( "node" )
    .data( rows )
    .enter()
    .append( "rect" )
    .attr("id", function(d, i){return d.id})
    .attr("class", function(d, i){return "node " + d.name})
    .attr("x", function(d, i) { 
      var E = (+d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M)));
      var x = d.a*(Math.cos(E)-d.e);
      return 0 + x*enlarge;
    })
    .attr("y", function(d, i) { 
      var E = (+d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M))); 
      var y = d.a*Math.sqrt(1-d.e*d.e)*Math.sin(E);
      return 0 + y*enlarge;
    })
    .attr("fill", function(d, i){
      if (d.pha === 'Y') {
        return "red";
      } else {
        return "rgba(255,255,255,.25)";
      }
    });
  
  dataBinding.each(function(d) {
    var node = d3.select(this);
  
    // setTimeout(function () {
      context.fillStyle = node.attr("fill");
      context.strokeStyle = "none";
      context.fillRect( node.attr("x"), node.attr("y"), 1, 1);
    // }, number++)
  });

  ready();
  readySetGo = true;

});

d3.csv("data/planets2.csv", function(error, rows) {
  if (error) throw error;

  // rows.forEach(function(d) {
  //   id: d.id;
  //   name: d.name;
  //   semimajor_axis: +d.a;
  //   eccentricity: +d.e;
  //   // magnitude: +d.mag;
  // });

  // function calc(d, i) {
  //  var E = d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M)); 
  //  var x = d.a*(Math.cos(E)-d.e);
  //  var y = d.a*Math.sqrt(1-d.e*d.e)*Math.sin(E);
  // };


  var dataBinding = dataContainer.selectAll( "node" )
    .data( rows )
    .enter()
    .append( "ellipse" )
    .attr("id", function(d, i){return d.id})
    .attr("class", function(d, i){return "node " + d.name})
    .attr("cx", function(d, i) { 
      var E = (+d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M)));
      var x = d.a*(Math.cos(E)-d.e);
      return x*enlarge;
    })
    .attr("cy", function(d, i) { 
      var E = (+d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M))); 
      var y = d.a*Math.sqrt(1-d.e*d.e)*Math.sin(E);
      return y*enlarge;
    })
    .attr("rx", function(d, i){return d.a * enlarge } )
    .attr("ry", function(d, i){return (d.a * Math.sqrt(1-(Math.pow(d.e,2)))) * enlarge } );
  
  dataBinding.each(function(d) {
    var node = d3.select(this);
  
    setTimeout(function () {
      context.fillStyle = "none";
      context.strokeStyle = 'rgba(46,210,123,1)';
      context.lineWidth = 2;
      context.beginPath();
      context.arc(node.attr("cx"), node.attr("cy"), 2, 0, 2 * Math.PI, true);
      context.stroke();
      context.closePath();
      context.fillStyle = "none";
      context.strokeStyle = 'rgba(46,210,123,1)';
      context.lineWidth = .5;
      context.beginPath();
      context.ellipse(0, 0, node.attr("rx"), node.attr("ry"), 0, 0, 2 * Math.PI, true);
      context.stroke();
      context.closePath();
    }, 200)

  });

  

});

// d3.csv("data/planets.csv", function(error, rows) {
//   if (error) throw error;

//   // rows.forEach(function(d) {
//   //   id: d.id;
//   //   name: d.name;
//   //   semimajor_axis: +d.a;
//   //   eccentricity: +d.e;
//   //   // magnitude: +d.mag;
//   // });


//   var dataBinding = dataContainer.selectAll( "node" )
//     .data( rows )
//     .enter()
//     .append( "ellipse" )
//     .attr("id", function(d, i){return d.id})
//     .attr("class", function(d, i){return "node " + d.name})
//     .attr("cx", 0)
//     .attr("cy", 0)
//     .attr("rx", function(d, i){return d.semimaj * enlarge } )
//     .attr("ry", function(d, i){return (d.semimaj * Math.sqrt(1-(Math.pow(d.ecc,2)))) * enlarge } );
  
//   dataBinding.each(function(d) {
//     var node = d3.select(this);
  
//     setTimeout(function () {
//       context.fillStyle = "none";
//       context.strokeStyle = 'rgba(46,210,123,1)';
//       context.lineWidth = 2;
//       context.beginPath();
//       context.ellipse(node.attr("cx"), node.attr("cy"), node.attr("rx"), node.attr("ry"), 0, 0, 2 * Math.PI, true);
//       context.stroke();
//       context.closePath();
//     }, 200)
//   });

// });

// function counter() {
//   number++;
//   var total = "0000000" + number;
//   return total.substr(total.length-7);
// }

// setTimeout( function() {
//   for (i = 0; i<19999; i++) {
//     d3.select("#a" + counter()).transition()
//       .duration(0)
//       .delay(2000 + number)
//       .style("stroke-width", function () { return .25 });
//   }

// }, 2000);

// function zoomed() {

resetTimers();
//   asteroidsGroup.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
//   // starsGroup.select(".county-border").style("stroke-width", .5 / d3.event.scale + "px");
// }

    canvas.style("-webkit-filter", "blur(" + 5 + "px)").style("opacity",.5);

var returnTimer = 0;
var returnCountdown = 0;
var returnLink = 0;
var returnNotification = d3.select('#return-notification');

document.body.addEventListener('mousemove', resetTimers);

function resetTimers() {
  clearTimeout(returnTimer);
  clearInterval(returnCountdown);
  clearTimeout(returnLink);
  countdown = 10;
  returnNotification.transition().duration(500).style("opacity", 0);
  setTimeout(function() {returnNotification.style("display", "none")}, 500);
  if (readySetGo) {
    ready();
  }
}

function ready() {
  document.getElementById('return-notification-message').innerHTML = "Returning to overview in 10 seconds";
  d3.select("#loading").transition().duration(500).style("opacity", 0);
  setTimeout(function() {d3.select("#loading").style("display", "none")}, 500);
  canvas.transition().delay(0).duration(1000)
                     .style("-webkit-filter", "blur(" + 0 + "px)")
                     .style("opacity",1);
  d3.select("#info").transition().duration(500).style('opacity', 1);
  returnTimer = setTimeout(returnToHub, 20000);
};

function returnToHub() {
  returnNotification.style("display", "block").transition().duration(500)
                    .style("opacity", 1);
  canvas.transition().delay(0).duration(10000).ease("linear-in-out")
                     .style("-webkit-filter", "blur(" + 5 + "px)")
                     .style("opacity",.2);
  d3.select("#info").transition().duration(8000).ease("linear-in-out")
                     .style('opacity', 0);

  var countdown = 10; 
  console.log(countdown);
  returnCountdown = setInterval(function() {
    countdown = countdown - 1;
    document.getElementById('return-notification-message').innerHTML = "Returning to overview in " + countdown + " seconds";
    console.log(countdown);
  }, 1000)
  returnLink = setTimeout(function() {returnNow();}, 10000)
}

function returnNow() {
    var oldURL = document.referrer;
    if (oldURL === "http://antonlecock.github.io/masterproject/hub/index.html") {
      window.history.back();
    } else {
      window.location.href = "http://antonlecock.github.io/masterproject/hub/index.html";
    }
  };

  </script>
</body>
</html>