<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Story</title>
  <style type="text/css">
    body {
      padding:0;
      margin:0;
      background-color:#12151a;
      font-family: BretzelGrotesk, sans-serif;
      letter-spacing: 1px;
      color:white;

      -webkit-font-smoothing: antialiased;
         -moz-font-smoothing: antialiased;
           -o-font-smoothing: antialiased;
              font-smoothing: antialiased;
    }
    text {
      font-size: 20px;
    }
    canvas { 
      width: 100%; 
      height: 100% 
    }
  </style>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<!--   <script src="data/20000.js" charset="utf-8"></script>
 --></head>

<body>
  <script type="text/javascript">

  var w = 1440*4, h = 1440*4;
  var paddingW = w/10,
      paddingH = h/10;

  var number  = 1000;
  var n = 400;

  var day = 5902;

  function degree(x) {
    return x - Math.floor(x/360.0)*360.0;
  }

  var k = 0.01720209895;

  var enlarge = 300;

  // COLORS    
  // var designerBlack = d3.rgb("#12141A"), // Define a nice black color for the background, store it as var
     var designerBlack = d3.rgb("#000000"),
      designerRed = d3.rgb("#c83c46"),
      designerWhite = d3.rgb("#ffe9d2");


  var hottestColor = d3.rgb("#9eb5ff"), // hottest color in the graph
      hotColor = d3.rgb("white"), // hot color in the graph
      midColor = d3.rgb("#ffe9d2")
      coldColor = d3.rgb("#ffd5a1"), // cold color in the graph
      coldestColor = d3.rgb("#ff5200"); // coldest color in the graph

      d3.select("body").style("background-color", designerBlack);


 // var svg = d3.select("body").append("svg")
 //                             .attr("id","svg")
 //                             .attr("class","svg")
 //                             .attr("width", w)
 //                             .attr("height", h);

  // Create the SVG Viewport
  var canvas = d3.select("body").append("canvas")
                             .attr("id","container")
                             .attr("class","container")
                             .attr("width", w)
                             .attr("height", h);

  var context = canvas.node().getContext('2d');

  var detachedContainer = document.createElement("custom");
  var dataContainer = d3.select(detachedContainer);

  context.fillStyle = "#12151a";
  context.strokeStyle = 'none';
  context.fillRect(0, 0, w, h);

  // context.fillStyle = "yellow";
  // context.strokeStyle = 'none';
  // context.beginPath();
  // context.arc(w/2, h/2, 2, 0, 2 * Math.PI, true);
  // context.fill();
  // context.closePath();

d3.csv("data/results_asteroids_n_pha2.csv", function(error, rows) {
  if (error) throw error;

  var dataBinding = dataContainer.selectAll( "node" )
    .data( rows )
    .enter()
    .append( "rect" )
    .attr("id", function(d, i){return d.id})
    .attr("class", function(d, i){return "node " + d.name})
    .attr("peri", function(d, i){return (d.a*(1-d.e))*enlarge})
    .attr("rx", function(d, i){return (d.a)*enlarge})
    .attr("ry", function(d, i){return (d.a*(Math.sqrt(1-Math.pow(d.e, 2))))*enlarge})
    .attr("F", function(d, i){
      var aSquared = Math.pow(d.a, 2);
      var bSquared = Math.pow(d.a*(Math.sqrt(1-Math.pow(d.e, 2))), 2);
      var F = Math.sqrt(aSquared - bSquared);
      console.log(F * enlarge);
      return F * enlarge;
    })
    .attr("aph", function(d, i){return (d.a*(1+d.e))*enlarge})
    // .attr("x", function(d, i){return w/2 + (d.a*(1-d.e))*enlarge})
    // .attr("y", function(d, i){return h/2 + (d.a*(1+d.e))*enlarge})
    .attr("focus", function(d, i){return w/2 - (d.a*(1-d.e))*enlarge})
    .attr("x", function(d, i) { 
      var Ezero, Eone;
        Ezero = (+d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M)));
        Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
        for (i = 0; i < 20; i++) {
          Ezero = Eone;
          Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
        }
      var E = Eone;
      var P = 2*Math.PI*Math.sqrt(d.a*d.a*d.a);
      var x = d.a*(Math.cos(E)-d.e);
      var y = d.a*Math.sqrt(1-d.e*d.e)*Math.sin(E);
      var r = Math.sqrt(x*x + y*y);
      var v = degree(Math.atan2(y, x) * (180/Math.PI));
      console.log("r = " + r + ", v = " + v);
      return w/2 + x * enlarge;
      // return w/2;
    })
    .attr("y", function(d, i) { 
      var Ezero, Eone;
        Ezero = (+d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M)));
        Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
        for (i = 0; i < 20; i++) {
          Ezero = Eone;
          Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
        }
      var E = Eone;
      var P = 2*Math.PI*Math.sqrt(d.a*d.a*d.a);
      var x = d.a*(Math.cos(E)-d.e);
      var y = d.a*Math.sqrt(1-d.e*d.e)*Math.sin(E);
      var r = Math.sqrt(x*x + y*y);
      var v = Math.atan2(y, x) * (180/Math.PI);
      return w/2 + y * enlarge;
      // return h/2;
    })
    .attr("rot", function(d, i){
      return d.M * (Math.PI/180);
    })
    .attr("v", function(d, i) {
       var Ezero, Eone;
        Ezero = (+d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M)));
        Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
        for (i = 0; i < 20; i++) {
          Ezero = Eone;
          Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
        }
      var E = Eone;
      var P = 2*Math.PI*Math.sqrt(d.a*d.a*d.a);
      var x = d.a*(Math.cos(E)-d.e);
      var y = d.a*Math.sqrt(1-d.e*d.e)*Math.sin(E);
      var r = Math.sqrt(x*x + y*y);
      var v = Math.atan2(y, x) * (180/Math.PI);
      return v;
      // return h/2;
    })
    .attr("fill", function(d, i){
      if (d.pha === 'Y') {
        return "rgba(255,0,0,.5)";
      } else {
        return "rgba(255,255,255,.3)";
      }
    });
  
  dataBinding.each(function(d) {
    var node = d3.select(this);
  
    // setTimeout(function () {
      context.translate(w/2, h/2);
      context.rotate(node.attr("v"));
      context.translate(-w/2, -h/2);

      context.fillStyle = node.attr("fill");
      context.strokeStyle = "none";
      context.fillRect( node.attr("x"), node.attr("y"), 1, 1);

      // context.fillStyle = "none";
      // context.strokeStyle = node.attr("fill");
      // context.lineWidth = .4;
      // context.beginPath();
      // context.ellipse(node.attr("x") - node.attr("F"), node.attr("y"), node.attr("rx"), node.attr("ry"), 0, 0, 2 * Math.PI, true);
      // context.stroke();
      // context.closePath();

      context.translate(w/2, h/2);
      context.rotate( - node.attr("v"));
      context.translate(-w/2, -h/2);

    // }, number++)
  });

});

d3.csv("data/planets2.csv", function(error, rows) {
  if (error) throw error;

  var dataBinding = dataContainer.selectAll( "node" )
    .data( rows )
    .enter()
    .append( "ellipse" )
    .attr("id", function(d, i){return d.id})
    .attr("class", function(d, i){return "node " + d.name})
    .attr("cx", function(d, i) { 
      var Ezero, Eone;
        Ezero = (+d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M)));
        Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
                  console.log(d.name + ", E0 = " + Ezero + ", E1 = " + Eone + ", E0 - E1 = " + (Eone-Ezero));

        for (i = 0; i < 20; i++) {
          Ezero = Eone;
          Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
          console.log(d.name + ", E0 = " + Ezero + ", E1 = " + Eone + ", E0 - E1 = " + (Eone-Ezero));
        }
      var E = Eone;
      var P = 2*Math.PI*Math.sqrt(d.a*d.a*d.a);
      // var v = 2*Math.atan(d.w)
      // var r = (d.a * (1-d.e))*(1+d.w*d.w);
      var x = d.a*(Math.cos(E)-d.e);
      return w/2 + x*enlarge
    })
    .attr("cy", function(d, i) { 
      var Ezero, Eone;
        Ezero = (+d.M+(180/Math.PI)*d.e*Math.sin(d.M)*(1+d.e*Math.cos(d.M)));
        Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
                  console.log(d.name + ", E0 = " + Ezero + ", E1 = " + Eone + ", E0 - E1 = " + (Eone-Ezero));

        for (i = 0; i < 20; i++) {
          Ezero = Eone;
          Eone = Ezero-(Ezero-(180/Math.PI)*d.e*Math.sin(Ezero)-d.M)/(1-d.e*Math.cos(Ezero));
          console.log(d.name + ", E0 = " + Ezero + ", E1 = " + Eone + ", E0 - E1 = " + (Eone-Ezero));
        }
      var E = Eone;
      var P = 2*Math.PI*Math.sqrt(d.a*d.a*d.a);
      var v = 2*Math.atan(d.w)
      var y = d.a*Math.sqrt(1-d.e*d.e)*Math.sin(E);
      return h/2 + y*enlarge;
    })
    .attr("rx", function(d, i){return d.a * enlarge } )
    .attr("ry", function(d, i){return (d.a * Math.sqrt(1-(Math.pow(d.e,2)))) * enlarge } );
  
  dataBinding.each(function(d) {
    var node = d3.select(this);
  
    setTimeout(function () {
      // context.fillStyle = "none";
      // context.strokeStyle = 'rgba(46,210,123,1)';
      // context.lineWidth = 2;
      // context.beginPath();
      // context.arc(node.attr("cx"), node.attr("cy"), 2, 0, 2 * Math.PI, true);
      // context.stroke();
      // context.closePath();
      context.fillStyle = "none";
      context.strokeStyle = 'rgba(255,0,0,1)';
      context.lineWidth = 3;
      context.beginPath();
      context.ellipse(w/2, h/2, node.attr("rx"), node.attr("ry"), 0, 0, 2 * Math.PI, true);
      context.stroke();
      context.closePath();
    }, 2000)
  });

});

// d3.csv("data/planets.csv", function(error, rows) {
//   if (error) throw error;

//   // rows.forEach(function(d) {
//   //   id: d.id;
//   //   name: d.name;
//   //   semimajor_axis: +d.a;
//   //   eccentricity: +d.e;
//   //   // magnitude: +d.mag;
//   // });


//   var dataBinding = dataContainer.selectAll( "node" )
//     .data( rows )
//     .enter()
//     .append( "ellipse" )
//     .attr("id", function(d, i){return d.id})
//     .attr("class", function(d, i){return "node " + d.name})
//     .attr("cx", 0)
//     .attr("cy", 0)
//     .attr("rx", function(d, i){return d.semimaj * enlarge } )
//     .attr("ry", function(d, i){return (d.semimaj * Math.sqrt(1-(Math.pow(d.ecc,2)))) * enlarge } );
  
//   dataBinding.each(function(d) {
//     var node = d3.select(this);
  
//     setTimeout(function () {
//       context.fillStyle = "none";
//       context.strokeStyle = 'rgba(46,210,123,1)';
//       context.lineWidth = 2;
//       context.beginPath();
//       context.ellipse(node.attr("cx"), node.attr("cy"), node.attr("rx"), node.attr("ry"), 0, 0, 2 * Math.PI, true);
//       context.stroke();
//       context.closePath();
//     }, 200)
//   });

// });

  </script>
</body>
</html>