<html>
<head>
  <meta charset="utf-8"/>
  <title>D3.js</title>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js" charset="utf-8"></script>
  <style type="text/css">
  body {
    padding:0;
    margin:0;
    background-color:#111;
    font-family:sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: white;
    shape-rendering: crispEdges;
  }

  .axis line {
    length: 400px;
    stroke:white;
  }

  text {
    font-family: sans-serif;
    font-size: 11px;
    fill:white;
  }

  circle {
    stroke-width:0;
    box-shadow: 0 0 2px #DDD;
  }

  circle.blur {
    fill:yellow;
  }

  .grid {
    stroke-width:1;
    stroke: black;
    shape-rendering: crispEdges;
    opacity: .2;
  }

  form {
    position:fixed;
    z-index:2;
    color:white;
  }

  .dragger-input {
    display:none;
  }

  </style>
</head>

<body>

<form>
  <label>Press spacebar to pause</label>
  <input id="slower-button" value="10x Slower" type="button" onClick="slower();"/>
  <input id="pause-button" value="Pause" type="button" onClick="pause();"/>
  <input id="faster-button" value="10x Faster" type="button" onClick="faster();"/>
</form>

  <script type="text/javascript">

    var ages = [300, 500, 530, 559, 580, 590, 600, 605, 609, 615, 619, 625, 630, 634, 640, 644, 650, 655, 659, 665, 669, 675, 680, 684, 690, 694, 700, 705, 709, 715, 719, 725, 730, 734, 740, 744, 750, 755, 759, 765, 769, 775, 780, 784, 790, 794, 800, 805, 810, 814, 819, 825, 830, 835, 839, 844, 850, 855, 860, 864, 869, 875, 880, 885, 889, 894, 900, 905, 910, 914, 919, 925, 930, 935, 939, 944, 950, 955, 960, 964, 969, 975, 980, 985, 989, 994]; //86 data files

    var age = undefined, //initial age is 1 (ages[1] => 300)
        t = ages[age], // age, time as log, so 10^t
        ageIndex = 1, // needed for refresh-time, see also tIndex = ages[agesIndex]
        tIndex = ages[ageIndex]; 

    var padding = 30,
        w = window.innerWidth,
        h = window.innerHeight;

    var speed = 4,
        time = 0, //time elapsed
        timeFactor = 10000, //refresh rate, in miliseconds
        paused = false; //timer is running (not paused)


    var M = [], //Mass, in solar mass
        L = [], //Luminosity, in solar luminosity
        Teff = [], //Effective Temperature, in K
        R = [], //Radius, in solar radii
        BV = []; //B-V color index

    var c; //color in RGB spectrum
    var hottestColor = d3.rgb("#9eb5ff"),
        middleColor = d3.rgb("white"),
        coldestColor = d3.rgb("#ff5200");


    //Indicate index of values in the dataset[] array 
    //For example, M is [2] of dataset[]
    var Marr = 2,
        Larr = 5,
        Teffarr = 3,
        BVarr = 8; 

    //Create the SVG Viewport
    var svgContainer = d3.select("body").append("svg")
                                        .attr("id","svg-container")
                                        .attr("class","svg-container")
                                        .attr("width", w)
                                        .attr("height", h);

    //Define the Scale for Teff (x)
    var TeffAxisScale = d3.scale.linear()
                                .domain([4.7, 3.5])
                                .range([padding, w-padding]);

    //Define the Scale for L (y)
    var LAxisScale = d3.scale.linear()
                             .domain([6.5, -3])
                             .range([padding, h-padding]);

    //Create the TeffAxis (x)
    var TeffAxis = d3.svg.axis()
                         .scale(TeffAxisScale)
                         .orient("bottom")
                         .ticks(5);
    
    //Create label on TeffAxis (x)
    var TeffAxisLabel = svgContainer.append("text")
                               .attr("class", "teff-label label")
                               .attr("x", w - (padding + 5))
                               .attr("y", h - (padding + 5))
                               .attr("text-anchor", "end")
                               .text("logTeff");

    //Create the LAxis (y)
    var LAxis = d3.svg.axis()
                      .scale(LAxisScale)
                      .orient("left")
                      .ticks(7);

    //Create label on LAxis (y)
    var LAxisLabel = svgContainer.append("text")
                           .attr("class", "l-label label")
                           .attr("x", padding + 5)
                           .attr("y", padding + 5)
                           .text("logL");
    
    //Create an SVG group Element for the TeffAxis elements and call the TeffAxis function (x)
    var TeffAxisGroup = svgContainer.append("g")
                                    .attr("class", "text teff-axis axis")
                                    .attr("transform", "translate(0," + (h - padding) + ")")
                                    .call(TeffAxis);

    //Create an SVG group Element for the TeffAxis elements and call the TeffAxis function (x)
    var LAxisGroup = svgContainer.append("g")
                                    .attr("class", "text l-axis axis")
                                    .attr("transform", "translate(" + padding + ", 0)")
                                    .call(LAxis);

    //Create an SVG group Element for the circles/stars
    var circlesGroup = svgContainer.append("g")
                                   .attr("class", "circlesgroup circles stars");

    var circlesFilter = svgContainer.append("filter")
                                    .attr("class", "circlesfilter")
                                    .attr("id", "circlesfilter"); 

    var circlesFilterBlur = circlesFilter.append("feGaussianBlur")
                                         .attr("in", "SourceGraphic")
                                         .attr("stdDeviation", "1");

    //Create an SVG group Element for the age / mass labels
    var labelGroup = svgContainer.append("g")
                                 .attr("class", "labelgroup labels");

    //Create an SVG group Element for the timeElapsed label, because it needs to be refreshed (emptied) often
    var timeElapsedGroup = svgContainer.append("g")
                                       .attr("class", "timeelapsedgroup labels");
    
    var dataValueTemp = 1;
    var dataValue;

    var up = true;
    var reachedMin = false,
        reachedMax = false;

    var pause = function () {
      if (paused === false) {
        paused = true;
        timeFactor = 0;
        document.getElementById("pause-button").value = "Resume";
        document.getElementById("slower-button").disabled = true;
        document.getElementById("faster-button").disabled = true;
      } else if (paused === true) {
        paused = false;
        timeFactor = 10000;
        document.getElementById("pause-button").value = "Pause";
        if (reachedMin === false) {
          document.getElementById("slower-button").disabled = false;
        } 
        if (reachedMax === false) {
          document.getElementById("faster-button").disabled = false;
        }
      }
    };
 
    $(window).keyup(function(e) {
        if (e.keyCode == 0 || e.keyCode == 32) {
          pause();
        }
      });

    var slower = function () {
      if (timeFactor >= 100) {
        timeFactor = timeFactor / 10;
        console.log("timeFactor is " + timeFactor);
        document.getElementById("slower-button").disabled = false;
        document.getElementById("faster-button").disabled = false;
        reachedMin = false;
      } else {
        document.getElementById("slower-button").disabled = true;
        reachedMin = true;
        alert("Timer has reached minimum!");
      }
    }

    var faster = function () {
      if (timeFactor <= 10000000) {
        timeFactor = timeFactor * 10;
        console.log("timeFactor is " + timeFactor);
        document.getElementById("faster-button").disabled = false;
        document.getElementById("slower-button").disabled = false;
        reachedMax = false;
      } else {
        document.getElementById("faster-button").disabled = true;
        reachedMax = true;
        alert("Timer has reached maximum!");
      }
    }

    //Update the value (dragger value)
    window.setInterval(function valueChanger () {

      if (dataValueTemp === ages.length) {
        up = false; 
      } else {
        up = true;
      }

      console.log(dataValueTemp);
      console.log(ages.length);

      if (up === true) {
        time = time + timeFactor;
      } else if (up === false) {
        time = time - timeFactor;
      }

      tIndex = d3.round(Math.pow(10, (ages[ageIndex] / 100)));
      //Remove previous timeElapsed value
      $(".timeelapsedgroup").empty();

      //Create timeElapsed label
      var timeElapsed = timeElapsedGroup.append("text")
                                        .attr("class", "label timeelapsed")
                                        .attr("x", w-padding)
                                        .attr("y", padding*1.5)
                                        .attr("text-anchor", "end")
                                        .text("Time elapsed = " + time + " years (+" + timeFactor + " every " + speed + " milliseconds)");

      if (time >= tIndex && paused === false) {


        if (dataValueTemp < ages.length) {
          if (up === true) {
            dataValueTemp ++;
            ageIndex ++;
          } else if (up === false) {
            dataValueTemp --;
            ageIndex --;
          }
        } else if (dataValueTemp === (ages.length) && up === true) {
          up = false;
        } else if (dataValueTemp > 1 && up === false) {
          dataValueTemp --;
          ageIndex --;
        } else { 
          up = true;
        };
        handleClick();

      }
    }, speed);


    //Function that does the magic
    function handleClick(event){
      age = Math.round(dataValueTemp) - 1;
      t = ages[age];

      drawDiagram(); //fill svgContainer with stellar goodness

      return false;

    };

    //the function that draws the diagram
    function drawDiagram (){


    var dataset = [],
        datasetTemp = [];

    var M = [],
        L = [],
        Teff = [],
        R = [],
        BV = [];

    // Import dataset from csv and parse it to array called dataset
    d3.text("data/iso_c020_0" + t + ".UBVRIJHKLM.csv", function(text) {
      var data = d3.csv.parseRows(text).map(function(row) {
        return row.map(function(value) {
          return +value;
        });
      });

      dataset = data;
    
    // Push values of dataset to arrays for each property (M, L, Teff)
    for (i = 0; i < dataset.length; i++) { 
      var temp = dataset[i];
      for (j = 0; j < dataset[i].length; j = j+21) {
        if (temp[Marr] <= 30) { // stars more massive than 30 solar masses are neglected
             M.push(parseFloat(temp[Marr]));
             L.push(parseFloat(temp[Larr]));
          Teff.push(parseFloat(temp[Teffarr]));
          if (temp[Marr] < 2) { // get R out of values through formula: R is proportional to M^0.9 for M < 2 Msol
            R.push(parseFloat(Math.pow(temp[Marr], 0.9))); 
          } else { // R is proportional to M^15/19 for 2 Msol < M < 20 Msol
            R.push(parseFloat(Math.pow(temp[Marr], 15/19)));
          };
           BV.push(parseFloat(temp[BVarr]));
        };
      };
    };

    

    // //convert Teff to RGB spectrum
    // function TeffToRGB (TeffIndex) {
      
    //   // TeffIndex to xyY
    //   var x, y = 0;
      
    //   if (TeffIndex >= 1667 && TeffIndex<=4000) {
    //     x = ((-0.2661239 * Math.pow(10,9)) / Math.pow(TeffIndex,3)) + ((-0.2343580 * Math.pow(10,6)) / Math.pow(TeffIndex,2)) + ((0.8776956 * Math.pow(10,3)) / TeffIndex) + 0.179910;
    //   } else if (TeffIndex > 4000 && TeffIndex <= 25000) {
    //     x = ((-3.0258469 * Math.pow(10,9)) / Math.pow(TeffIndex,3)) + ((2.1070379 * Math.pow(10,6)) / Math.pow(TeffIndex,2)) + ((0.2226347 * Math.pow(10,3)) / TeffIndex) + 0.240390;
    //   }
      
    //   if (TeffIndex >= 1667 && TeffIndex <= 2222) {
    //     y = -1.1063814 * Math.pow(x,3) - 1.34811020 * Math.pow(x,2) + 2.18555832 * x - 0.20219683;
    //   } else if (TeffIndex > 2222 && TeffIndex <= 4000) {
    //     y = -0.9549476 * Math.pow(x,3) - 1.37418593 * Math.pow(x,2) + 2.09137015 * x - 0.16748867;
    //   } else if (TeffIndex > 4000 && TeffIndex <= 25000) {
    //     y = 3.0817580 * Math.pow(x,3) - 5.87338670 * Math.pow(x,2) + 3.75112997 * x - 0.37001483;
    //   }
    
    //   // xyY to XYZ, Y = 1
    //   var Y = 1.0
    //   var X = (y == 0)? 0 : (x * Y) / y
    //   var Z = (y == 0)? 0 : ((1 - x - y) * Y) / y
    
    //   //XYZ to rgb
    //   var r = 3.2406 * X - 1.5372 * Y - 0.4986 * Z
    //   var g = -0.9689 * X + 1.8758 * Y + 0.0415 * Z
    //   var b = 0.0557 * X - 0.2040 * Y + 1.0570 * Z
      
    //   //linear RGB to sRGB
    //   var R = (r <= 0.0031308)? 12.92*r : 1.055*Math.pow(r,1/2.4)-0.055
    //   var G = (g <= 0.0031308)? 12.92*g : 1.055*Math.pow(g,1/2.4)-0.055
    //   var B = (b <= 0.0031308)? 12.92*b : 1.055*Math.pow(b,1/2.4)-0.055
    
    //   console.log("R is " + R*255)
    //   console.log("G is " + G*255)
    //   console.log("B is " + B*255)
    //   return [Math.round(R*255),Math.round(G*255),Math.round(B*255)]
    // } 

    // for (i = 0; i < Teff.length; i++) {
    //   console.log(TeffToRGB[i]);
    //   var c = TeffToRGB(i);
    // }


    // push each property back into array in right order
    for (i = 0; i < M.length; i++) {
      var datasetTempArray = [M[i], L[i], Teff[i], R[i], BV[i]]; // M = 0, L = 1, Teff = 2, R = 3, BV = 4
      var datasetTempArraySlice = datasetTempArray.slice();
      datasetTemp.push(datasetTempArraySlice);
    };

    dataset = datasetTemp;


    //Get max/min values of data
    var max_M = d3.max(M),
        min_M = d3.min(M),
        max_Teff = d3.max(Teff),
        min_Teff = d3.min(Teff),
        max_L = d3.max(L),
        min_L = d3.min(L),
        max_R = d3.max(R),
        min_R = d3.min(R),
        max_BV = d3.max(BV),
        min_BV = d3.min(BV),
        mean_BV = d3.mean(BV);
    

    //Round min/max values 
    var maxRound_Teff = d3.round(max_Teff),
        minRound_Teff = d3.round(min_Teff),
        maxRound_L = d3.round(max_L)
        minRound_L = d3.round(min_L);


    //Define the Scale for R (size circles)
    var RScale = d3.scale.linear()
                         .domain([max_R, min_R])
                         .range([5,1]);

    //Define scale for the colors of stars, c
    var cScale = d3.scale.linear()
                         .domain([max_BV, mean_BV, min_BV])
                         .range([coldestColor, middleColor, hottestColor]);

    $(".circlesgroup").empty(); //make svg groups empty
    $(".labelgroup").empty();   //

    var circles = circlesGroup.selectAll("circle.shape")
                              .data(dataset)
                              .enter()
                              .append("circle")
                              .attr("class", "shape")
                              .attr("cx", function(d) {return TeffAxisScale(d[2]); })
                              .attr("cy", function(d) {return LAxisScale(d[1]); })
                              .attr("r", function(d) {return RScale(d[3]); })
                              .attr("fill", function(d) {return cScale(d[4]); });
     
    //Create age label
    var timeStamp = labelGroup.append("text")
                              .attr("class", "label timestamp")
                              .attr("x", w-padding)
                              .attr("y", padding)
                              .attr("text-anchor", "end")
                              .text("log(age) = " + t / 100 + " (these stars are about " + d3.round(Math.pow(10, t/100)) + " years old)");

    //Label for most massive
    var mostMassive = labelGroup.append("text")
                                .attr("class", "label masstext")
                                .attr("x", w-padding)
                                .attr("y", padding*2)
                                .attr("text-anchor", "end")
                                .text("Most massive = " + max_M + " Msol");

    //Label  for least massive
    var leastMassive = labelGroup.append("text")
                                 .attr("class", "label masstext")
                                 .attr("x", w-padding)
                                 .attr("y", padding*2.5)
                                 .attr("text-anchor", "end")
                                 .text("Least massive = " + min_M + " Msol");

    
    });
    };

    handleClick();
    
  </script>
</body>